<!DOCTYPE html>
<html lang="en">
<head>
    <title>Molecule Viewer - (C60-Ih)[5,6]fullerene</title>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        
            #container {
                position: relative;
                width: 100%;
                height: 100vh;
            }
            #molecule-label {
                position: absolute;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                color: white;
                font-family: Arial, sans-serif;
                font-size: 18px;
                background-color: rgba(0, 0, 0, 0.7);
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1000;
                pointer-events: none;
                text-align: center;
                max-width: 80%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .atom-label {
                text-shadow: -1px 1px 1px rgb(0,0,0);
                margin-left: 5px;
                font-size: 14px;
                color: white;
                pointer-events: none;
            }
        
        
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
        }
        
        #controls button {
            background-color: #333;
            color: white;
            border: 1px solid #666;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        
        #controls button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
<div id="container"></div>
<div id="molecule-label">(C60-Ih)[5,6]fullerene</div>

<script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
  }
}
</script>
<script type="module">

import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { PDBLoader } from 'three/addons/loaders/PDBLoader.js';
import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

let camera, scene, renderer, labelRenderer, controls;
let root, labelsGroup;
const rotationSpeed = 0.0015; // Speed of auto-rotation (radians per frame)

// Configuration settings
const config = {
    enableAnnotations: true  // Default setting - can be toggled
};

init();
animate();

function init() {
    const container = document.getElementById('container');

    // Scene
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);

    // Camera
    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 5000);
    camera.position.z = 500;

    // Lights
    const light1 = new THREE.DirectionalLight(0xffffff, 2.5);
    light1.position.set(1, 1, 1);
    scene.add(light1);

    const light2 = new THREE.DirectionalLight(0xffffff, 1.5);
    light2.position.set(-1, -1, 1);
    scene.add(light2);

    // Root group and labels group
    root = new THREE.Group();
    scene.add(root);

    // Renderer
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);
    
    // CSS2D Renderer for atom labels
    labelRenderer = new CSS2DRenderer();
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.domElement.style.position = 'absolute';
    labelRenderer.domElement.style.top = '0px';
    labelRenderer.domElement.style.pointerEvents = 'none';
    container.appendChild(labelRenderer.domElement);

    // Controls
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 1.5;

    // Handle resize
    window.addEventListener('resize', onWindowResize);
    
    // Add labelRenderer resize tracking
    if (!window.labelRendererResizeListener) {
        window.labelRendererResizeListener = true;
        window.addEventListener('resize', () => {
            if (window.labelRenderer) {
                const container = document.querySelector('#container');
                if (container) {
                    window.labelRenderer.setSize(container.clientWidth, container.clientHeight);
                }
            }
        });
    }

    // Add camera fitting function
    function fitCameraToMolecule() {
        const box = new THREE.Box3();
        root.children.forEach(child => {
            if (!(child instanceof THREE.Light)) {
                box.expandByObject(child);
            }
        });
        
        const size = box.getSize(new THREE.Vector3());
        const center = box.getCenter(new THREE.Vector3());
        
        // Calculate distance based on diagonal
        const diagonal = Math.sqrt(
            size.x * size.x + 
            size.y * size.y + 
            size.z * size.z
        );
        
        // Increase distance for larger molecules using log scale
        const scaleFactor = Math.max(1.2, Math.log10(diagonal) * 0.8);
        const distance = diagonal * scaleFactor;
        
        // Position camera using spherical coordinates
        const theta = Math.PI / 4; // 45 degrees
        const phi = Math.PI / 6;   // 30 degrees
        
        camera.position.set(
            center.x + distance * Math.sin(theta) * Math.cos(phi),
            center.y + distance * Math.sin(phi),
            center.z + distance * Math.cos(theta) * Math.cos(phi)
        );
        
        camera.lookAt(center);
        controls.target.copy(center);
        
        // Adjust near/far planes
        camera.near = distance * 0.01;
        camera.far = distance * 10;
        camera.updateProjectionMatrix();
        
        // Update controls min/max distance
        controls.minDistance = distance * 0.1;
        controls.maxDistance = distance * 5;
        controls.update();
    }

    // Load molecule
    const pdbData = `COMPND    123591
HETATM    1  C1  UNL     1       2.677  -0.465   0.000  1.00  0.00           C  
HETATM    2  C2  UNL     1       2.053   1.120   0.000  1.00  0.00           C  
HETATM    3  C3  UNL     1       8.968  -2.043   0.000  1.00  0.00           C  
HETATM    4  C4  UNL     1       6.852  -1.754   0.000  1.00  0.00           C  
HETATM    5  C5  UNL     1       2.445   3.363   0.000  1.00  0.00           C  
HETATM    6  C6  UNL     1       7.468   4.674   0.000  1.00  0.00           C  
HETATM    7  C7  UNL     1       4.697  -2.840   0.000  1.00  0.00           C  
HETATM    8  C8  UNL     1       7.448  -4.129   0.000  1.00  0.00           C  
HETATM    9  C9  UNL     1       0.589   2.878   0.000  1.00  0.00           C  
HETATM   10  C10 UNL     1       7.339  -0.968   0.000  1.00  0.00           C  
HETATM   11  C11 UNL     1       7.059   1.009   0.000  1.00  0.00           C  
HETATM   12  C12 UNL     1       8.675  -0.029   0.000  1.00  0.00           C  
HETATM   13  C13 UNL     1       4.715  -1.397   0.000  1.00  0.00           C  
HETATM   14  C14 UNL     1       4.911   0.392   0.000  1.00  0.00           C  
HETATM   15  C15 UNL     1       6.648   3.088   0.000  1.00  0.00           C  
HETATM   16  C16 UNL     1       1.854   0.142   0.000  1.00  0.00           C  
HETATM   17  C17 UNL     1       5.616  -2.383   0.000  1.00  0.00           C  
HETATM   18  C18 UNL     1       2.063  -4.122   0.000  1.00  0.00           C  
HETATM   19  C19 UNL     1       6.145  -3.981   0.000  1.00  0.00           C  
HETATM   20  C20 UNL     1       8.577   4.049   0.000  1.00  0.00           C  
HETATM   21  C21 UNL     1       5.875  -5.150   0.000  1.00  0.00           C  
HETATM   22  C22 UNL     1       7.054   2.385   0.000  1.00  0.00           C  
HETATM   23  C23 UNL     1       9.341   1.786   0.000  1.00  0.00           C  
HETATM   24  C24 UNL     1       6.243  -0.205   0.000  1.00  0.00           C  
HETATM   25  C25 UNL     1       7.086  -3.109   0.000  1.00  0.00           C  
HETATM   26  C26 UNL     1       7.201  -4.714   0.000  1.00  0.00           C  
HETATM   27  C27 UNL     1       4.602  -5.685   0.000  1.00  0.00           C  
HETATM   28  C28 UNL     1       3.790  -4.737   0.000  1.00  0.00           C  
HETATM   29  C29 UNL     1       3.774   3.854   0.000  1.00  0.00           C  
HETATM   30  C30 UNL     1       5.591   1.626   0.000  1.00  0.00           C  
HETATM   31  C31 UNL     1       8.049   3.492   0.000  1.00  0.00           C  
HETATM   32  C32 UNL     1       3.267  -3.205   0.000  1.00  0.00           C  
HETATM   33  C33 UNL     1       8.845  -2.621   0.000  1.00  0.00           C  
HETATM   34  C34 UNL     1       1.729  -2.309   0.000  1.00  0.00           C  
HETATM   35  C35 UNL     1       0.480  -0.822   0.000  1.00  0.00           C  
HETATM   36  C36 UNL     1       0.670  -0.504   0.000  1.00  0.00           C  
HETATM   37  C37 UNL     1       4.520   2.469   0.000  1.00  0.00           C  
HETATM   38  C38 UNL     1       5.585   5.101   0.000  1.00  0.00           C  
HETATM   39  C39 UNL     1       5.014  -4.590   0.000  1.00  0.00           C  
HETATM   40  C40 UNL     1       7.696  -1.129   0.000  1.00  0.00           C  
HETATM   41  C41 UNL     1       1.325  -3.121   0.000  1.00  0.00           C  
HETATM   42  C42 UNL     1       3.586   0.951   0.000  1.00  0.00           C  
HETATM   43  C43 UNL     1       3.464  -1.623   0.000  1.00  0.00           C  
HETATM   44  C44 UNL     1       5.616  -3.657   0.000  1.00  0.00           C  
HETATM   45  C45 UNL     1       7.595   1.062   0.000  1.00  0.00           C  
HETATM   46  C46 UNL     1       7.159   4.560   0.000  1.00  0.00           C  
HETATM   47  C47 UNL     1       2.652   4.522   0.000  1.00  0.00           C  
HETATM   48  C48 UNL     1      -0.034  -1.800   0.000  1.00  0.00           C  
HETATM   49  C49 UNL     1       5.083  -1.180   0.000  1.00  0.00           C  
HETATM   50  C50 UNL     1       9.997  -1.403   0.000  1.00  0.00           C  
HETATM   51  C51 UNL     1       3.500   2.632   0.000  1.00  0.00           C  
HETATM   52  C52 UNL     1       3.054  -0.296   0.000  1.00  0.00           C  
HETATM   53  C53 UNL     1       0.722   1.222   0.000  1.00  0.00           C  
HETATM   54  C54 UNL     1       9.916   0.543   0.000  1.00  0.00           C  
HETATM   55  C55 UNL     1       5.532   4.201   0.000  1.00  0.00           C  
HETATM   56  C56 UNL     1       8.919   1.993   0.000  1.00  0.00           C  
HETATM   57  C57 UNL     1       1.964   2.606   0.000  1.00  0.00           C  
HETATM   58  C58 UNL     1       4.581   5.211   0.000  1.00  0.00           C  
HETATM   59  C59 UNL     1       0.341   1.367   0.000  1.00  0.00           C  
HETATM   60  C60 UNL     1       5.542   3.680   0.000  1.00  0.00           C  
CONECT    1   13   13   16   36
CONECT    2   16   51   51   53
CONECT    3   12   12   25   50
CONECT    4   10   19   40   40
CONECT    5    9   29   29   47
CONECT    6   20   31   31   55
CONECT    7   17   25   25   28
CONECT    8   19   21   21   33
CONECT    9   53   59   59
CONECT   10   11   11   49
CONECT   11   14   22
CONECT   12   23   24
CONECT   13   32   44
CONECT   14   37   37   52
CONECT   15   37   38   46   46
CONECT   16   52   52
CONECT   17   24   24   43
CONECT   18   28   34   41   41
CONECT   19   26   26
CONECT   20   46   56   56
CONECT   21   25   27
CONECT   22   45   45   46
CONECT   23   31   54   54
CONECT   24   30
CONECT   26   39   44
CONECT   27   28   28   39
CONECT   29   38   51
CONECT   30   42   42   60
CONECT   31   60
CONECT   32   39   39   41
CONECT   33   40   50   50
CONECT   34   35   43   43
CONECT   35   48   48   59
CONECT   36   48   53   53
CONECT   37   51
CONECT   38   55   55
CONECT   40   45
CONECT   41   48
CONECT   42   43   57
CONECT   44   49   49
CONECT   45   56
CONECT   47   57   57   58
CONECT   49   52
CONECT   50   54
CONECT   54   56
CONECT   55   58
CONECT   57   59
CONECT   58   60   60
END
`;
    const pdbBlob = new Blob([pdbData], { type: 'text/plain' });
    const pdbUrl = URL.createObjectURL(pdbBlob);

    // Make PDBLoader available globally for compatibility with both approaches
    window.PDBLoader = PDBLoader;
    const loader = new PDBLoader();
    const scaleFactor = .3;
    
    // Array to track all labels
    const labels = [];
    
    // Add toggle function to root
    root.toggleAnnotations = function(enable) {
        if (typeof enable === 'boolean') {
            root.enableAnnotations = enable;
        } else {
            root.enableAnnotations = !root.enableAnnotations;
        }
        
        // Toggle visibility of each label
        labels.forEach(label => {
            label.visible = root.enableAnnotations;
        });
        
        return root.enableAnnotations;
    };
    
    // Set initial annotation state
    root.enableAnnotations = config.enableAnnotations;

    loader.load(pdbUrl, (pdb) => {
        const geometryAtoms = pdb.geometryAtoms;
        const geometryBonds = pdb.geometryBonds;
        const json = pdb.json;
        const boxGeometry = new THREE.BoxGeometry(1, 1, 1);
        const sphereGeometry = new THREE.IcosahedronGeometry(1, 3);
        const offset = new THREE.Vector3();

        geometryAtoms.computeBoundingBox();
        geometryAtoms.boundingBox.getCenter(offset).negate();

        geometryAtoms.translate(offset.x, offset.y, offset.z);
        geometryBonds.translate(offset.x, offset.y, offset.z);

        let positions = geometryAtoms.getAttribute('position');
        const colors = geometryAtoms.getAttribute('color');
        const position = new THREE.Vector3();
        const color = new THREE.Color();

        // Add atoms and their labels
        for (let i = 0; i < positions.count; i++) {
            position.set(
                positions.getX(i),
                positions.getY(i),
                positions.getZ(i)
            );
            color.setRGB(
                colors.getX(i),
                colors.getY(i),
                colors.getZ(i)
            );

            const material = new THREE.MeshPhongMaterial({ color: color });
            const atom = new THREE.Mesh(sphereGeometry, material);
            atom.position.copy(position).multiplyScalar(120 * scaleFactor);
            atom.scale.setScalar(40 * scaleFactor);
            root.add(atom);
            
            // Add atom labels using CSS2DObject
            if (config.enableAnnotations && json.atoms[i]) {
                const atomSymbol = json.atoms[i][4];
                if (atomSymbol) {
                    const text = document.createElement('div');
                    text.className = 'atom-label';
                    text.textContent = atomSymbol;
                    text.style.color = `rgb(${Math.round(color.r*255)},${Math.round(color.g*255)},${Math.round(color.b*255)})`;
                    
                    // Create CSS2DObject and attach it directly to the scene
                    const label = new CSS2DObject(text);
                    label.position.copy(atom.position);
                    scene.add(label);
                    
                    // Add reference to the label for toggling
                    labels.push(label);
                }
            }
        }

        // Add bonds
        positions = geometryBonds.getAttribute('position');
        const start = new THREE.Vector3();
        const end = new THREE.Vector3();

        for (let i = 0; i < positions.count; i += 2) {
            start.set(
                positions.getX(i),
                positions.getY(i),
                positions.getZ(i)
            ).multiplyScalar(120 * scaleFactor);

            end.set(
                positions.getX(i+1),
                positions.getY(i+1),
                positions.getZ(i+1)
            ).multiplyScalar(120 * scaleFactor);

            const bondMesh = new THREE.Mesh(
                boxGeometry,
                new THREE.MeshPhongMaterial({ color: 0xffffff })
            );
            bondMesh.position.copy(start).lerp(end, 0.5);
            bondMesh.scale.set(8 * scaleFactor, 8 * scaleFactor, start.distanceTo(end));
            bondMesh.lookAt(end);
            root.add(bondMesh);
        }

        // Clean up
        URL.revokeObjectURL(pdbUrl);

        // Fit camera to the molecule after loading
        fitCameraToMolecule();
    });
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    requestAnimationFrame(animate);
    
    // Update controls
    controls.update();
    
    // Render both the 3D scene and labels
    renderer.render(scene, camera);
    labelRenderer.render(scene, camera);
}
</script>
</body>
</html>
