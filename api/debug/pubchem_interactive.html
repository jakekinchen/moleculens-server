<!DOCTYPE html>
<html lang="en">
<head>
    <title>Molecule Viewer</title>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #container {
            position: relative;
            width: 100%;
            height: 100vh;
        }
        #molecule-label {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-family: Arial, sans-serif;
            font-size: 18px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            pointer-events: none;
            text-align: center;
            max-width: 80%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .atom-label {
            text-shadow: -1px 1px 1px rgb(0,0,0);
            margin-left: 5px;
            font-size: 14px;
            color: white;
            pointer-events: none;
        }
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
        }
        #controls button {
            background-color: #333;
            color: white;
            border: 1px solid #666;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.3s;
        }
        #controls button:hover {
            background-color: #555;
        }
        /* Pause icon in top-left corner */
        #pause-icon {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 30px;
            height: 30px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 4px;
            display: none; /* hidden by default */
            z-index: 2000;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 24px;
            text-align: center;
            line-height: 30px;
        }
    </style>
</head>
<body>
<div id="container"></div>
<div id="molecule-label"></div>
<div id="pause-icon">||</div>

<script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
  }
}
</script>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { PDBLoader } from 'three/addons/loaders/PDBLoader.js';
import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

// ======== Highlight configuration ========
// Controls the "glow" color and intensity for highlighted atoms
let highlightColor = new THREE.Color(0xffcc00);  // default highlight color
let highlightIntensity = 2.0;                    // how strong the emissive glow is

// ======== Script playback controls ========
let isPlaying = true;                // default is "playing"
let currentTime = 0;                 // current time in seconds of the "script"
let currentStepIndex = 0;            // which step in the script we are on
let lastStepTime = 0;                // track the final step's time (for cleanup)
let previousStepAtoms = [];          // remember which atoms were highlighted last
let steps = [];                      // will store script steps with numeric timecodes
let scriptStart = 0;                 // for timing reference
let pauseIcon;                       // DOM element for pause icon

// Global variable to control auto-rotation
let autoRotateEnabled = false;

// Three.js global references
let camera, scene, renderer, labelRenderer, controls;
let root;
const atomMeshes = []; // Store references to atom meshes for highlighting

// Script object we want to animate through
const scriptData = {
  "title": "(C60-Ih)[5,6]fullerene",
  "content": [
    {
      "timecode": "00:00",
      "atoms": [],
      "caption": "Buckminsterfullerene, also known as C60 or 'buckyball', is one of the most symmetrical molecules discovered in nature."
    },
    {
      "timecode": "00:08",
      "atoms": [
        "0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9"
      ],
      "caption": "This molecule consists of exactly 60 carbon atoms arranged in a spherical structure resembling a soccer ball."
    },
    {
      "timecode": "00:16",
      "atoms": [
        "0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15"
      ],
      "caption": "The carbon atoms form a truncated icosahedron with 12 pentagonal and 20 hexagonal faces, creating its distinctive spherical cage structure."
    },
    {
      "timecode": "00:24",
      "atoms": [
        "16",
        "17",
        "18",
        "19",
        "20",
        "21",
        "22",
        "23",
        "24",
        "25"
      ],
      "caption": "Each carbon atom is bonded to three others, forming a network of alternating single and double bonds throughout the structure."
    },
    {
      "timecode": "00:32",
      "atoms": [
        "26",
        "27",
        "28",
        "29",
        "30",
        "31",
        "32",
        "33",
        "34",
        "35"
      ],
      "caption": "This arrangement gives C60 remarkable stability despite its hollow structure, as each carbon achieves a full valence shell through sp\u00b2 hybridization."
    },
    {
      "timecode": "00:40",
      "atoms": [
        "0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11"
      ],
      "caption": "The 12 pentagonal rings are isolated from each other, surrounded by hexagonal rings, which contributes to the molecule's stability."
    },
    {
      "timecode": "00:48",
      "atoms": [
        "12",
        "13",
        "14",
        "15",
        "16",
        "17",
        "18",
        "19",
        "20",
        "21"
      ],
      "caption": "This pattern follows what's known as the 'isolated pentagon rule' in fullerene chemistry, minimizing strain in the molecular structure."
    },
    {
      "timecode": "00:56",
      "atoms": [
        "22",
        "23",
        "24",
        "25",
        "26",
        "27",
        "28",
        "29",
        "30",
        "31"
      ],
      "caption": "With a molecular weight of 720.6 g/mol, C60 is a substantial carbon allotrope that behaves differently from other carbon forms like graphite or diamond."
    },
    {
      "timecode": "01:04",
      "atoms": [
        "32",
        "33",
        "34",
        "35",
        "36",
        "37",
        "38",
        "39",
        "40",
        "41"
      ],
      "caption": "The molecule exhibits icosahedral symmetry (Ih), the highest symmetry possible for any molecule, with 120 symmetry operations."
    },
    {
      "timecode": "01:12",
      "atoms": [
        "42",
        "43",
        "44",
        "45",
        "46",
        "47",
        "48",
        "49",
        "50",
        "51"
      ],
      "caption": "This high symmetry gives buckminsterfullerene unique electronic properties, including the ability to act as an electron acceptor in various applications."
    },
    {
      "timecode": "01:20",
      "atoms": [
        "52",
        "53",
        "54",
        "55",
        "56",
        "57",
        "58",
        "59"
      ],
      "caption": "The name honors architect Buckminster Fuller, whose geodesic domes share the same geometric principles as this molecule's structure."
    },
    {
      "timecode": "01:28",
      "atoms": [
        "0",
        "10",
        "20",
        "30",
        "40",
        "50",
        "59"
      ],
      "caption": "Discovered in 1985, C60 was the first fullerene identified and led to the 1996 Nobel Prize in Chemistry for Curl, Kroto, and Smalley."
    },
    {
      "timecode": "01:36",
      "atoms": [
        "0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15"
      ],
      "caption": "Beyond its scientific significance, buckminsterfullerene has potential applications in materials science, electronics, and medicine."
    },
    {
      "timecode": "01:44",
      "atoms": [
        "0",
        "1",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "11",
        "12",
        "13",
        "14",
        "15",
        "16",
        "17",
        "18",
        "19"
      ],
      "caption": "Its hollow interior can encapsulate atoms or small molecules, making it useful for drug delivery systems and as molecular containers."
    },
    {
      "timecode": "01:52",
      "atoms": [],
      "caption": "This remarkable carbon sphere continues to inspire research in nanotechnology and supramolecular chemistry, demonstrating how geometric principles influence molecular properties."
    }
  ]
};

/**
 * Converts "MM:SS" into total seconds
 */
function parseTimecode(timecode) {
    const [minutes, seconds] = timecode.split(':').map(Number);
    return minutes * 60 + seconds;
}

/**
 * Initialize script steps with parsed timecodes
 */
function initScript() {
    steps = scriptData.content.map(s => ({
        ...s,
        timeInSeconds: parseTimecode(s.timecode)
    }));
    // Sort by timeInSeconds in case they are out of order
    steps.sort((a, b) => a.timeInSeconds - b.timeInSeconds);
    lastStepTime = steps.length ? steps[steps.length - 1].timeInSeconds : 0;

    // Start from time=0 at load
    currentTime = 0;
    currentStepIndex = -1;
    scriptStart = performance.now() * 0.001;
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
}

/**
 * Toggles auto-rotation on/off
 */
function toggleAutoRotate() {
    autoRotateEnabled = !autoRotateEnabled;
    controls.autoRotate = autoRotateEnabled;
    return autoRotateEnabled; // Return the new state
}

/**
 * Main animation loop
 */
function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
    labelRenderer.render(scene, camera);

    // Advance script timeline if playing
    if (isPlaying) {
        const now = performance.now() * 0.001; // seconds
        // currentTime = how long since we unpaused
        currentTime = now - scriptStart;
        updateScript();
    }
}

/**
 * Check if it's time to move to the next step, highlight, unhighlight, etc.
 */
function updateScript() {
    // If we've passed the final step by 5s, unhighlight everything
    if (currentTime > lastStepTime + 5) {
        unhighlightAll();
        return;
    }

    // Find the largest step whose time <= currentTime
    let newIndex = 0;
    for (let i = 0; i < steps.length; i++) {
        if (steps[i].timeInSeconds <= currentTime) {
            newIndex = i;
        }
    }

    // If we changed steps, update highlight/caption
    if (newIndex !== currentStepIndex) {
        // Unhighlight old step's atoms
        unhighlightAtoms(previousStepAtoms, 500);

        // Highlight new step's atoms
        const step = steps[newIndex];
        const atomIndices = step.atoms.map(Number);
        highlightAtoms(atomIndices, 500);

        // Update caption
        const labelEl = document.getElementById('molecule-label');
        if (labelEl) labelEl.textContent = step.caption;

        previousStepAtoms = atomIndices;
        currentStepIndex = newIndex;
    }
}

/**
 * Skip to the next step
 */
 function skipForward() {
  if (currentStepIndex < steps.length - 1) {
    // 1. Figure out next step index but don't assign it yet
    const nextIndex = currentStepIndex + 1;
    // 2. Jump to that step's time
    currentTime = steps[nextIndex].timeInSeconds;
    scriptStart = performance.now() * 0.001 - currentTime;
    // 3. DO NOT do currentStepIndex = nextIndex here
    // 4. Let updateScript() handle the index change
    updateScript();
  }
}

function skipBackward() {
  if (currentStepIndex > 0) {
    const prevIndex = currentStepIndex - 1;
    currentTime = steps[prevIndex].timeInSeconds;
    scriptStart = performance.now() * 0.001 - currentTime;
    updateScript();
  }
}

/**
 * Sets up keyboard listeners for space (pause/play) and left/right arrows (skip).
 */
function setupKeyboardControls() {
    window.addEventListener('keydown', (event) => {
        if (event.code === 'Space') {
            event.preventDefault(); // avoid page scroll
            togglePlayPause();
        } else if (event.code === 'ArrowRight') {
            event.preventDefault();
            skipForward();
        } else if (event.code === 'ArrowLeft') {
            event.preventDefault();
            skipBackward();
        }
    });

    // Set up button controls
    const rewindButton = document.getElementById('rewind');
    const playPauseButton = document.getElementById('play-pause');
    const fastForwardButton = document.getElementById('fast-forward');

    if (rewindButton) {
        rewindButton.addEventListener('click', skipBackward);
    }

    if (playPauseButton) {
        playPauseButton.addEventListener('click', togglePlayPause);
    }

    if (fastForwardButton) {
        fastForwardButton.addEventListener('click', skipForward);
    }
}

/**
 * Toggles play/pause state and handles icon display
 */
function togglePlayPause() {
    isPlaying = !isPlaying;
    if (isPlaying) {
        // Resume from currentTime
        scriptStart = performance.now() * 0.001 - currentTime;
        pauseIcon.style.display = 'none';
    } else {
        // Pausing: keep currentTime as is
        pauseIcon.style.display = 'block';
    }
}

/**
 * Adjusts the camera to fit the molecule in view
 */
function fitCameraToMolecule() {
    if (!root) return;

    const boundingBox = new THREE.Box3().setFromObject(root);
    const center = new THREE.Vector3();
    boundingBox.getCenter(center);
    const size = new THREE.Vector3();
    boundingBox.getSize(size);

    const maxDim = Math.max(size.x, size.y, size.z);
    const fov = camera.fov * (Math.PI / 180);
    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));

    cameraZ *= 1.5;

    camera.position.z = cameraZ;
    const minZ = boundingBox.min.z;
    const cameraToFarEdge = (minZ < 0) ? -minZ + cameraZ : cameraZ - minZ;
    camera.far = cameraToFarEdge * 3;
    camera.updateProjectionMatrix();

    controls.target.copy(center);
    controls.update();
}

function init() {
    const container = document.getElementById('container');
    pauseIcon = document.getElementById('pause-icon');

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);

    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 5000);
    camera.position.z = 500;

    const light1 = new THREE.DirectionalLight(0xffffff, 2.5);
    light1.position.set(1, 1, 1);
    scene.add(light1);

    const light2 = new THREE.DirectionalLight(0xffffff, 1.5);
    light2.position.set(-1, -1, 1);
    scene.add(light2);

    root = new THREE.Group();
    scene.add(root);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    labelRenderer = new CSS2DRenderer();
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.domElement.style.position = 'absolute';
    labelRenderer.domElement.style.top = '0px';
    labelRenderer.domElement.style.pointerEvents = 'none';
    container.appendChild(labelRenderer.domElement);

    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.autoRotate = autoRotateEnabled;
    controls.autoRotateSpeed = 1.5;
    controls.enableKeys = false;
    window.addEventListener('resize', onWindowResize);

    // PDB data for norbornane
    const pdbData = `COMPND    123591
HETATM    1  C1  UNL     1       2.677  -0.465   0.000  1.00  0.00           C  
HETATM    2  C2  UNL     1       2.053   1.120   0.000  1.00  0.00           C  
HETATM    3  C3  UNL     1       8.968  -2.043   0.000  1.00  0.00           C  
HETATM    4  C4  UNL     1       6.852  -1.754   0.000  1.00  0.00           C  
HETATM    5  C5  UNL     1       2.445   3.363   0.000  1.00  0.00           C  
HETATM    6  C6  UNL     1       7.468   4.674   0.000  1.00  0.00           C  
HETATM    7  C7  UNL     1       4.697  -2.840   0.000  1.00  0.00           C  
HETATM    8  C8  UNL     1       7.448  -4.129   0.000  1.00  0.00           C  
HETATM    9  C9  UNL     1       0.589   2.878   0.000  1.00  0.00           C  
HETATM   10  C10 UNL     1       7.339  -0.968   0.000  1.00  0.00           C  
HETATM   11  C11 UNL     1       7.059   1.009   0.000  1.00  0.00           C  
HETATM   12  C12 UNL     1       8.675  -0.029   0.000  1.00  0.00           C  
HETATM   13  C13 UNL     1       4.715  -1.397   0.000  1.00  0.00           C  
HETATM   14  C14 UNL     1       4.911   0.392   0.000  1.00  0.00           C  
HETATM   15  C15 UNL     1       6.648   3.088   0.000  1.00  0.00           C  
HETATM   16  C16 UNL     1       1.854   0.142   0.000  1.00  0.00           C  
HETATM   17  C17 UNL     1       5.616  -2.383   0.000  1.00  0.00           C  
HETATM   18  C18 UNL     1       2.063  -4.122   0.000  1.00  0.00           C  
HETATM   19  C19 UNL     1       6.145  -3.981   0.000  1.00  0.00           C  
HETATM   20  C20 UNL     1       8.577   4.049   0.000  1.00  0.00           C  
HETATM   21  C21 UNL     1       5.875  -5.150   0.000  1.00  0.00           C  
HETATM   22  C22 UNL     1       7.054   2.385   0.000  1.00  0.00           C  
HETATM   23  C23 UNL     1       9.341   1.786   0.000  1.00  0.00           C  
HETATM   24  C24 UNL     1       6.243  -0.205   0.000  1.00  0.00           C  
HETATM   25  C25 UNL     1       7.086  -3.109   0.000  1.00  0.00           C  
HETATM   26  C26 UNL     1       7.201  -4.714   0.000  1.00  0.00           C  
HETATM   27  C27 UNL     1       4.602  -5.685   0.000  1.00  0.00           C  
HETATM   28  C28 UNL     1       3.790  -4.737   0.000  1.00  0.00           C  
HETATM   29  C29 UNL     1       3.774   3.854   0.000  1.00  0.00           C  
HETATM   30  C30 UNL     1       5.591   1.626   0.000  1.00  0.00           C  
HETATM   31  C31 UNL     1       8.049   3.492   0.000  1.00  0.00           C  
HETATM   32  C32 UNL     1       3.267  -3.205   0.000  1.00  0.00           C  
HETATM   33  C33 UNL     1       8.845  -2.621   0.000  1.00  0.00           C  
HETATM   34  C34 UNL     1       1.729  -2.309   0.000  1.00  0.00           C  
HETATM   35  C35 UNL     1       0.480  -0.822   0.000  1.00  0.00           C  
HETATM   36  C36 UNL     1       0.670  -0.504   0.000  1.00  0.00           C  
HETATM   37  C37 UNL     1       4.520   2.469   0.000  1.00  0.00           C  
HETATM   38  C38 UNL     1       5.585   5.101   0.000  1.00  0.00           C  
HETATM   39  C39 UNL     1       5.014  -4.590   0.000  1.00  0.00           C  
HETATM   40  C40 UNL     1       7.696  -1.129   0.000  1.00  0.00           C  
HETATM   41  C41 UNL     1       1.325  -3.121   0.000  1.00  0.00           C  
HETATM   42  C42 UNL     1       3.586   0.951   0.000  1.00  0.00           C  
HETATM   43  C43 UNL     1       3.464  -1.623   0.000  1.00  0.00           C  
HETATM   44  C44 UNL     1       5.616  -3.657   0.000  1.00  0.00           C  
HETATM   45  C45 UNL     1       7.595   1.062   0.000  1.00  0.00           C  
HETATM   46  C46 UNL     1       7.159   4.560   0.000  1.00  0.00           C  
HETATM   47  C47 UNL     1       2.652   4.522   0.000  1.00  0.00           C  
HETATM   48  C48 UNL     1      -0.034  -1.800   0.000  1.00  0.00           C  
HETATM   49  C49 UNL     1       5.083  -1.180   0.000  1.00  0.00           C  
HETATM   50  C50 UNL     1       9.997  -1.403   0.000  1.00  0.00           C  
HETATM   51  C51 UNL     1       3.500   2.632   0.000  1.00  0.00           C  
HETATM   52  C52 UNL     1       3.054  -0.296   0.000  1.00  0.00           C  
HETATM   53  C53 UNL     1       0.722   1.222   0.000  1.00  0.00           C  
HETATM   54  C54 UNL     1       9.916   0.543   0.000  1.00  0.00           C  
HETATM   55  C55 UNL     1       5.532   4.201   0.000  1.00  0.00           C  
HETATM   56  C56 UNL     1       8.919   1.993   0.000  1.00  0.00           C  
HETATM   57  C57 UNL     1       1.964   2.606   0.000  1.00  0.00           C  
HETATM   58  C58 UNL     1       4.581   5.211   0.000  1.00  0.00           C  
HETATM   59  C59 UNL     1       0.341   1.367   0.000  1.00  0.00           C  
HETATM   60  C60 UNL     1       5.542   3.680   0.000  1.00  0.00           C  
CONECT    1   13   13   16   36
CONECT    2   16   51   51   53
CONECT    3   12   12   25   50
CONECT    4   10   19   40   40
CONECT    5    9   29   29   47
CONECT    6   20   31   31   55
CONECT    7   17   25   25   28
CONECT    8   19   21   21   33
CONECT    9   53   59   59
CONECT   10   11   11   49
CONECT   11   14   22
CONECT   12   23   24
CONECT   13   32   44
CONECT   14   37   37   52
CONECT   15   37   38   46   46
CONECT   16   52   52
CONECT   17   24   24   43
CONECT   18   28   34   41   41
CONECT   19   26   26
CONECT   20   46   56   56
CONECT   21   25   27
CONECT   22   45   45   46
CONECT   23   31   54   54
CONECT   24   30
CONECT   26   39   44
CONECT   27   28   28   39
CONECT   29   38   51
CONECT   30   42   42   60
CONECT   31   60
CONECT   32   39   39   41
CONECT   33   40   50   50
CONECT   34   35   43   43
CONECT   35   48   48   59
CONECT   36   48   53   53
CONECT   37   51
CONECT   38   55   55
CONECT   40   45
CONECT   41   48
CONECT   42   43   57
CONECT   44   49   49
CONECT   45   56
CONECT   47   57   57   58
CONECT   49   52
CONECT   50   54
CONECT   54   56
CONECT   55   58
CONECT   57   59
CONECT   58   60   60
END
`;
    const pdbBlob = new Blob([pdbData], { type: 'text/plain' });
    const pdbUrl = URL.createObjectURL(pdbBlob);

    const loader = new PDBLoader();
    const scaleFactor = 0.7;

    loader.load(pdbUrl, (pdb) => {
        const geometryAtoms = pdb.geometryAtoms;
        const geometryBonds = pdb.geometryBonds;
        const json = pdb.json;

        // Center the geometry
        const offset = new THREE.Vector3();
        geometryAtoms.computeBoundingBox();
        geometryAtoms.boundingBox.getCenter(offset).negate();
        geometryAtoms.translate(offset.x, offset.y, offset.z);
        geometryBonds.translate(offset.x, offset.y, offset.z);

        const sphereGeometry = new THREE.IcosahedronGeometry(1, 3);
        const boxGeometry = new THREE.BoxGeometry(1, 1, 1);

        const positions = geometryAtoms.getAttribute('position');
        const colors = geometryAtoms.getAttribute('color');
        const position = new THREE.Vector3();
        const color = new THREE.Color();

        // Create atoms
        for (let i = 0; i < positions.count; i++) {
            position.set(
                positions.getX(i),
                positions.getY(i),
                positions.getZ(i)
            );
            color.setRGB(
                colors.getX(i),
                colors.getY(i),
                colors.getZ(i)
            );

            const material = new THREE.MeshPhongMaterial({
                color: color.clone(),
                emissive: 0x000000,
                emissiveIntensity: 1.0
            });

            const atom = new THREE.Mesh(sphereGeometry, material);
            atom.position.copy(position).multiplyScalar(120 * scaleFactor);
            atom.scale.setScalar(40 * scaleFactor);
            root.add(atom);

            // Store original emissive for highlight fade
            atom.userData.originalEmissive = new THREE.Color(0x000000);
            // Also store original emissive intensity
            atom.userData.originalEmissiveIntensity = atom.material.emissiveIntensity;

            atomMeshes.push(atom);

            const atomSymbol = json.atoms[i] && json.atoms[i][4];
            if (atomSymbol) {
                const text = document.createElement('div');
                text.className = 'atom-label';
                text.textContent = atomSymbol;
                const label = new CSS2DObject(text);
                label.position.copy(atom.position);
                scene.add(label);
            }
        }

        // Create bonds
        const bondPositions = geometryBonds.getAttribute('position');
        const start = new THREE.Vector3();
        const end = new THREE.Vector3();

        for (let i = 0; i < bondPositions.count; i += 2) {
            start.set(
                bondPositions.getX(i),
                bondPositions.getY(i),
                bondPositions.getZ(i)
            ).multiplyScalar(120 * scaleFactor);

            end.set(
                bondPositions.getX(i + 1),
                bondPositions.getY(i + 1),
                bondPositions.getZ(i + 1)
            ).multiplyScalar(120 * scaleFactor);

            const bondMesh = new THREE.Mesh(
                boxGeometry,
                new THREE.MeshPhongMaterial({ color: 0xffffff })
            );
            bondMesh.position.copy(start).lerp(end, 0.5);
            bondMesh.scale.set(8 * scaleFactor, 8 * scaleFactor, start.distanceTo(end));
            bondMesh.lookAt(end);
            root.add(bondMesh);
        }

        URL.revokeObjectURL(pdbUrl);
        fitCameraToMolecule();

        // Initialize script steps
        initScript();
    });
}

/**
 * Animates the `emissive` color + intensity from one value to another over "duration" ms.
 */
function animateEmissiveTransition(atom, fromEmissive, toEmissive, fromIntensity, toIntensity, duration) {
    const startTime = performance.now();

    function tick(now) {
        const elapsed = now - startTime;
        const t = Math.min(1, elapsed / duration);

        const er = fromEmissive.r + (toEmissive.r - fromEmissive.r) * t;
        const eg = fromEmissive.g + (toEmissive.g - fromEmissive.g) * t;
        const eb = fromEmissive.b + (toEmissive.b - fromEmissive.b) * t;
        atom.material.emissive.setRGB(er, eg, eb);

        const intensity = fromIntensity + (toIntensity - fromIntensity) * t;
        atom.material.emissiveIntensity = intensity;

        if (t < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
}

/**
 * Highlight: fade emissive from current to highlightColor & set highlightIntensity
 */
function highlightAtoms(indices, duration = 500) {
    indices.forEach(i => {
        const atom = atomMeshes[i];
        if (atom) {
            const fromEmissive = atom.material.emissive.clone();
            const toEmissive = highlightColor.clone();
            const fromIntensity = atom.material.emissiveIntensity;
            const toIntensity = highlightIntensity;

            animateEmissiveTransition(atom, fromEmissive, toEmissive, fromIntensity, toIntensity, duration);
        }
    });
}

/**
 * Unhighlight: fade emissive back to original color/intensity
 */
function unhighlightAtoms(indices, duration = 500) {
    indices.forEach(i => {
        const atom = atomMeshes[i];
        if (atom) {
            const fromEmissive = atom.material.emissive.clone();
            const toEmissive = atom.userData.originalEmissive.clone(); // typically black
            const fromIntensity = atom.material.emissiveIntensity;
            const toIntensity = atom.userData.originalEmissiveIntensity;

            animateEmissiveTransition(atom, fromEmissive, toEmissive, fromIntensity, toIntensity, duration);
        }
    });
}

/**
 * Unhighlight all atoms
 */
function unhighlightAll(duration = 500) {
    const indices = Array.from(atomMeshes.keys());
    unhighlightAtoms(indices, duration);
}

setupKeyboardControls();
init();
animate();
</script>
</body>
</html>